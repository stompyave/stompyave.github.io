<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Our Moods <3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
      color: #2d3748;
      min-height: 100vh; /* allow scrolling */
    }

    .mood-circle {
      transition: background-color 0.3s ease-in-out;
      width: 100px;
      height: 100px;
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      background: #cbd5e0;
      border-radius: 4px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      background: #4a5568;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #ffffff;
    }

    input[type="range"]::-moz-range-thumb {
      width: 24px;
      height: 24px;
      background: #4a5568;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #ffffff;
    }

    .gender-btn {
      font-size: 1.5rem;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      cursor: pointer;
      transition: transform 0.2s, background-color 0.2s;
    }
    .gender-btn:hover {
      transform: scale(1.1);
    }
    .gender-selected {
      box-shadow: 0 0 0 3px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body class="flex flex-col items-center justify-start p-4">
  <div class="max-w-xl w-full p-8 bg-white rounded-3xl shadow-2xl space-y-8 text-center border border-gray-200">
    <h1 class="text-4xl font-bold text-gray-800 mb-2">Our Moods <3</h1>
    <p class="text-gray-500 mb-8">Move the sliders to set your current mood :3</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <!-- Your Mood -->
      <div class="flex flex-col items-center space-y-4 p-6 bg-gray-50 rounded-2xl shadow-inner border border-gray-100">
        <h2 class="text-2xl font-semibold text-gray-700">My Mood</h2>
        <div id="your-circle" class="mood-circle rounded-full border-4 border-white shadow-lg"></div>
        <input id="your-mood-slider" type="range" min="0" max="100" value="50" class="w-full">
        <span id="your-mood-value" class="text-lg font-medium text-gray-600">50</span>

        <!-- Your Gender -->
        <div class="flex space-x-4 mt-4" id="your-gender-buttons">
          <button class="gender-btn bg-pink-200" data-gender="female">♀</button>
          <button class="gender-btn bg-yellow-200" data-gender="neutral">⚧</button>
          <button class="gender-btn bg-blue-200" data-gender="male">♂</button>
        </div>
      </div>

      <!-- Partner Mood -->
      <div class="flex flex-col items-center space-y-4 p-6 bg-gray-50 rounded-2xl shadow-inner border border-gray-100">
        <h2 class="text-2xl font-semibold text-gray-700">My Partner's Mood</h2>
        <div id="partner-circle" class="mood-circle rounded-full border-4 border-white shadow-lg"></div>
        <input id="partner-mood-slider" type="range" min="0" max="100" value="50" class="w-full" disabled>
        <span id="partner-mood-value" class="text-lg font-medium text-gray-600">50</span>

        <!-- Partner Gender (read-only) -->
        <div id="partner-gender" class="text-3xl mt-4"></div>
      </div>
    </div>

    <!-- Notes Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
      <!-- Your Note -->
      <div class="flex flex-col space-y-2 p-4 bg-gray-50 rounded-2xl border border-gray-100">
        <h3 class="text-lg font-semibold text-gray-700">My Note</h3>
        <textarea id="your-note" rows="4" class="p-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-400"></textarea>
      </div>

      <!-- Partner's Note -->
      <div class="flex flex-col space-y-2 p-4 bg-gray-50 rounded-2xl border border-gray-100">
        <h3 class="text-lg font-semibold text-gray-700">My Partner's Note</h3>
        <textarea id="partner-note" rows="4" class="p-2 rounded-lg border border-gray-300 bg-gray-100" disabled></textarea>
      </div>
    </div>

    <p id="user-id-display" class="text-xs text-gray-400 mt-6"></p>
    <div id="message-box" class="hidden fixed top-4 right-4 bg-blue-500 text-white p-4 rounded-lg shadow-xl z-50"></div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('debug');

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = {
      apiKey: "AIzaSyCpMxICBcoNU6HqkpO4uh1vq10kE0U1yk4",
      authDomain: "stompyave.firebaseapp.com",
      projectId: "stompyave",
      storageBucket: "stompyave.firebasestorage.app",
      messagingSenderId: "798943688217",
      appId: "1:798943688217:web:d3d8e00665078836ca5c88",
      measurementId: "G-GNN6L9MB0C"
    };

    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    const messageBox = document.getElementById('message-box');
    function showMessage(message, duration = 3000) {
      messageBox.textContent = message;
      messageBox.classList.remove('hidden');
      setTimeout(() => { messageBox.classList.add('hidden'); }, duration);
    }

    let db, auth, userId;
    const moodDocId = 'current_moods';
    const moodCollectionPath = `/artifacts/${appId}/public/data/mood-meters`;

    let isDraggingSlider = false;
    let dragTimeout;

    window.onload = function() {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
          if (user) {
            userId = user.uid;
            document.getElementById('user-id-display').textContent = `Your User ID: ${userId}`;
            setupRealtimeUpdates();
            setupSliderListeners();
            setupNoteListeners();
            setupGenderListeners();
            showMessage("Successfully signed in.");
          } else {
            try {
              if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
              } else {
                await signInAnonymously(auth);
              }
            } catch (error) {
              console.error("Authentication error:", error);
              showMessage("Authentication failed. Please try again.");
            }
          }
        });
      } catch (e) {
        console.error("Firebase Initialization Error:", e);
        showMessage("Failed to initialize the application.");
      }
    };

    function setupRealtimeUpdates() {
      if (!userId) return;
      const docRef = doc(db, moodCollectionPath, moodDocId);

      onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          if (!isDraggingSlider) updateUI(data);
          updateNotes(data);
          updateGenders(data);
        } else {
          setDoc(docRef, { [`${userId}`]: 50, [`${userId}_note`]: "", [`${userId}_gender`]: "" });
        }
      });
    }

    function updateUI(data) {
      const yourSlider = document.getElementById('your-mood-slider');
      const yourValueSpan = document.getElementById('your-mood-value');
      const yourCircle = document.getElementById('your-circle');

      const partnerSlider = document.getElementById('partner-mood-slider');
      const partnerValueSpan = document.getElementById('partner-mood-value');
      const partnerCircle = document.getElementById('partner-circle');

      if (data[`${userId}`] !== undefined) {
        const yourMood = data[`${userId}`];
        yourSlider.value = yourMood;
        yourValueSpan.textContent = yourMood;
        updateMoodCircle(yourCircle, yourMood);
      }

      const otherUserId = Object.keys(data).find(key =>
        !key.includes("_note") && !key.includes("_gender") && key !== `${userId}`
      );
      if (otherUserId && data[otherUserId] !== undefined) {
        const partnerMood = data[otherUserId];
        partnerSlider.value = partnerMood;
        partnerValueSpan.textContent = partnerMood;
        updateMoodCircle(partnerCircle, partnerMood);
      }
    }

    function updateNotes(data) {
      const yourNoteBox = document.getElementById('your-note');
      const partnerNoteBox = document.getElementById('partner-note');

      if (data[`${userId}_note`] !== undefined) {
        yourNoteBox.value = data[`${userId}_note`];
      }

      const otherUserNoteKey = Object.keys(data).find(key => key.endsWith("_note") && key !== `${userId}_note`);
      if (otherUserNoteKey) partnerNoteBox.value = data[otherUserNoteKey];
    }

    function updateGenders(data) {
      // Highlight your gender button
      if (data[`${userId}_gender`]) {
        const buttons = document.querySelectorAll("#your-gender-buttons .gender-btn");
        buttons.forEach(b => {
          b.classList.remove("gender-selected");
          if (b.dataset.gender === data[`${userId}_gender`]) {
            b.classList.add("gender-selected");
          }
        });
      }

      // Show partner's gender
      const partnerGenderBox = document.getElementById('partner-gender');
      const otherUserGenderKey = Object.keys(data).find(key => key.endsWith("_gender") && key !== `${userId}_gender`);
      if (otherUserGenderKey) {
        const g = data[otherUserGenderKey];
        partnerGenderBox.textContent = g === "female" ? "♀" : g === "male" ? "♂" : g === "neutral" ? "⚧" : "";
      }
    }

    function updateMoodCircle(circleElement, moodValue) {
      const mood = parseInt(moodValue);
      circleElement.className = 'mood-circle rounded-full border-4 border-white shadow-lg';
      if (mood < 25) circleElement.classList.add('bg-red-200');
      else if (mood < 50) circleElement.classList.add('bg-yellow-200');
      else if (mood < 75) circleElement.classList.add('bg-lime-200');
      else circleElement.classList.add('bg-green-200');
    }

    function setupSliderListeners() {
      const yourSlider = document.getElementById('your-mood-slider');
      const docRef = doc(db, moodCollectionPath, moodDocId);

      yourSlider.addEventListener('input', (event) => {
        clearTimeout(dragTimeout);
        isDraggingSlider = true;
        const moodValue = event.target.value;
        document.getElementById('your-mood-value').textContent = moodValue;
        updateMoodCircle(document.getElementById('your-circle'), moodValue);

        setDoc(docRef, { [`${userId}`]: parseInt(moodValue) }, { merge: true });
        dragTimeout = setTimeout(() => { isDraggingSlider = false; }, 500);
      });
    }

    function setupNoteListeners() {
      const yourNoteBox = document.getElementById('your-note');
      const docRef = doc(db, moodCollectionPath, moodDocId);

      yourNoteBox.addEventListener('input', (event) => {
        setDoc(docRef, { [`${userId}_note`]: event.target.value }, { merge: true });
      });
    }

    function setupGenderListeners() {
      const buttons = document.querySelectorAll("#your-gender-buttons .gender-btn");
      const docRef = doc(db, moodCollectionPath, moodDocId);

      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          buttons.forEach(b => b.classList.remove("gender-selected"));
          btn.classList.add("gender-selected");
          const genderValue = btn.dataset.gender;
          setDoc(docRef, { [`${userId}_gender`]: genderValue }, { merge: true });
        });
      });
    }
  </script>
</body>
</html>
