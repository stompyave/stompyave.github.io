import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// Enable debug logging for Firestore
setLogLevel('debug');

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = {
    apiKey: "AIzaSyCpMxICBcoNU6HqkpO4uh1vq10kE0U1yk4",
    authDomain: "stompyave.firebaseapp.com",
    projectId: "stompyave",
    storageBucket: "stompyave.firebasestorage.app",
    messagingSenderId: "798943688217",
    appId: "1:798943688217:web:d3d8e00665078836ca5c88",
    measurementId: "G-GNN6L9MB0C"
};

const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

const messageBox = document.getElementById('message-box');
function showMessage(message, duration = 3000) {
    messageBox.textContent = message;
    messageBox.classList.remove('hidden', 'translate-x-full');
    messageBox.classList.add('translate-x-0');
    setTimeout(() => {
        messageBox.classList.remove('translate-x-0');
        messageBox.classList.add('translate-x-full');
        setTimeout(() => {
            messageBox.classList.add('hidden');
        }, 300);
    }, duration);
}

let db, auth, userId;
const moodDocId = 'current_moods';
const moodCollectionPath = `/artifacts/${appId}/public/data/mood-meters`;

// Add a new variable to act as a flag
let isUpdatingSlider = false;

window.onload = function() {
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('user-id-display').textContent = `Your User ID: ${userId}`;
                setupRealtimeUpdates();
                setupSliderListeners();
                showMessage("Successfully signed in.");
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication error:", error);
                    showMessage("Authentication failed. Please try again.");
                }
            }
        });
    } catch (e) {
        console.error("Firebase Initialization Error:", e);
        showMessage("Failed to initialize the application.");
    }
};

function setupRealtimeUpdates() {
    if (!userId) {
        console.warn("User ID not available, skipping Firestore setup.");
        return;
    }

    const docRef = doc(db, moodCollectionPath, moodDocId);
    onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();
            // Only update the UI if the slider isn't being actively dragged
            if (!isUpdatingSlider) {
                updateUI(data);
            }
        } else {
            console.log("No data found, creating initial document.");
            setDoc(docRef, { yourMood: 50, partnerMood: 50, [`${userId}`]: 50 });
        }
    }, (error) => {
        console.error("Failed to get realtime updates:", error);
        showMessage("Failed to get real-time updates.");
    });
}

function updateUI(data) {
    const yourSlider = document.getElementById('your-mood-slider');
    const yourValueSpan = document.getElementById('your-mood-value');
    const yourCircle = document.getElementById('your-circle');

    const partnerSlider = document.getElementById('partner-mood-slider');
    const partnerValueSpan = document.getElementById('partner-mood-value');
    const partnerCircle = document.getElementById('partner-circle');

    // Update your mood if it's in the data
    if (data[`${userId}`]) {
        const yourMood = data[`${userId}`];
        yourSlider.value = yourMood;
        yourValueSpan.textContent = yourMood;
        updateMoodCircle(yourCircle, yourMood);
    }

    // Find and update the partner's mood
    const otherUserId = Object.keys(data).find(key => key !== 'yourMood' && key !== 'partnerMood' && key !== `${userId}`);
    if (otherUserId && data[otherUserId]) {
        const partnerMood = data[otherUserId];
        partnerSlider.value = partnerMood;
        partnerValueSpan.textContent = partnerMood;
        updateMoodCircle(partnerCircle, partnerMood);
    } else {
        partnerSlider.value = 50;
        partnerValueSpan.textContent = 50;
        updateMoodCircle(partnerCircle, 50);
    }
}

function updateMoodCircle(circleElement, moodValue) {
    const mood = parseInt(moodValue);
    circleElement.className = 'mood-circle rounded-full border-4 border-white shadow-lg';
    if (mood < 25) {
        circleElement.classList.add('bg-red-200');
    } else if (mood < 50) {
        circleElement.classList.add('bg-yellow-200');
    } else if (mood < 75) {
        circleElement.classList.add('bg-lime-200');
    } else {
        circleElement.classList.add('bg-green-200');
    }
}

function setupSliderListeners() {
    const yourSlider = document.getElementById('your-mood-slider');
    const docRef = doc(db, moodCollectionPath, moodDocId);

    yourSlider.addEventListener('input', (event) => {
        // Set the flag to true to prevent the onSnapshot listener from updating the UI
        isUpdatingSlider = true;

        const moodValue = event.target.value;
        document.getElementById('your-mood-value').textContent = moodValue;
        updateMoodCircle(document.getElementById('your-circle'), moodValue);
        
        // Update Firestore document with the new mood value
        setDoc(docRef, { [`${userId}`]: parseInt(moodValue) }, { merge: true }).catch(e => {
            console.error("Failed to update Firestore:", e);
            showMessage("Failed to save mood.");
        });
    });

    // Add a 'change' event listener to set the flag back to false
    yourSlider.addEventListener('change', () => {
        // Use a small delay to ensure the last Firestore update is received before we resume UI updates
        setTimeout(() => {
            isUpdatingSlider = false;
        }, 500); // 500ms delay
    });
}
